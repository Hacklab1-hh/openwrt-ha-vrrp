<%+header%>
<h2>HA VRRP â€“ Status</h2>
<pre>
<%
 local uci=require"luci.model.uci".cursor()
 local function out_inst(sec)
   local name=uci:get("ha_vrrp",sec,"name") or sec
   local vrid=uci:get("ha_vrrp",sec,"vrid") or "-"
   local vip=uci:get("ha_vrrp",sec,"vip_cidr") or "-"
   local iface=uci:get("ha_vrrp",sec,"iface") or "-"
   local use_vlan=uci:get("ha_vrrp",sec,"use_vlan") or "0"
   local vlan=uci:get("ha_vrrp",sec,"vlan_id") or ""
   if use_vlan=="1" and vlan~="" then iface=iface.."."..vlan end
   write(string.format("Instance: %s  VRID: %s  IF: %s  VIP: %s\\n", name, vrid, iface, vip))
 end

 -- list instances
 for sec in uci:sections("ha_vrrp") do
   if sec:match("^inst_") or sec=="core" then out_inst(sec) end
 end
%>
</pre>

<div class="cbi-page-actions">
  <button class="cbi-button cbi-button-apply" onclick="applyHA()">Apply & Restart Keepalived</button>
</div>

<script>
function applyHA(){
  fetch(L.env.cgi_base + '/admin/services/ha_vrrp/apply',{method:'POST'})
    .then(r=>r.json()).then(j=>{
      alert(j.ok?'OK':'Error');
      location.reload();
    }).catch(()=>alert('Error'));
}
</script>
<%+footer%>
